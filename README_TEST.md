# OCR测试脚本使用说明

本项目提供了两个独立的测试脚本，可以在不依赖数据库的情况下测试图片上传和OCR解析功能。

## 测试脚本

### 1. test_ocr.py - OCR解析测试

**功能**: 直接测试OCR识别功能，不涉及文件上传流程

**使用方法**:
```bash
# 测试单张图片
python test_ocr.py test_images/alipay_bill.jpg

# 批量测试多张图片
python test_ocr.py test_images/*.jpg
python test_ocr.py test_images/alipay_bill.jpg test_images/wechat_bill.png
```

**输出示例**:
```
================================================================================
📸 测试图片: test_images/alipay_bill.jpg
================================================================================
📁 文件大小: 245.67 KB
🔍 开始OCR识别...

⏱️  识别耗时: 2.35 秒

✅ 解析成功
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 账单信息:
   💰 金额: ¥50.00
   📅 日期: 2024-01-15
   🏪 商户: 餐厅名称
   📊 分类: 支出
   🏷️  类型: 餐饮
   📝 描述: 餐厅名称
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📄 识别文本:
    1. 支付宝
    2. 付款成功
    3. ¥50.00
    ...
```

### 2. test_upload.py - 完整上传流程测试

**功能**: 模拟完整的图片上传流程，包括文件保存、OCR识别、账单创建

**使用方法**:
```bash
# 测试单张图片（自动创建账单）
python test_upload.py test_images/alipay_bill.jpg

# 批量测试（自动创建账单）
python test_upload.py test_images/*.jpg

# 不自动创建账单
python test_upload.py test_images/alipay_bill.jpg --no-auto-bill

# 测试完成后清理测试文件
python test_upload.py test_images/*.jpg --cleanup
```

**输出示例**:
```
================================================================================
📤 模拟上传: test_images/alipay_bill.jpg
================================================================================

✅ 文件验证通过
   - 文件名: alipay_bill.jpg
   - 文件大小: 245.67 KB
   - 文件类型: .jpg

✅ 文件保存成功
   - 保存路径: test_uploads/1/1_20240115_120000_123456.jpg
   - 保存文件名: 1_20240115_120000_123456.jpg

🔍 开始OCR识别...
⏱️  识别耗时: 2.35 秒
✅ OCR识别成功
   账单类型: alipay

📋 解析结果:
   💰 金额: ¥50.00
   📅 日期: 2024-01-15
   🏪 商户: 餐厅名称
   📊 分类: 支出
   🏷️  类型: 餐饮
   📝 描述: 餐厅名称

✅ 自动创建账单:
   - 标题: 餐厅名称
   - 金额: ¥50.0
   - 分类: 支出
   - 类型: 餐饮
   - 日期: 2024-01-15

================================================================================
✅ 上传流程完成
================================================================================
```

## 支持的图片格式

- JPG / JPEG
- PNG
- BMP
- GIF

## 文件大小限制

- 最大文件大小: 10MB

## 测试文件目录

- `test_ocr.py`: 不创建文件，直接读取原图片
- `test_upload.py`: 测试文件保存在 `test_uploads/` 目录

## 依赖要求

确保已安装以下Python包：

```bash
cd backend
pip install -r requirements.txt
```

主要依赖：
- PaddleOCR
- OpenCV
- Pillow
- NumPy

## 常见问题

### 1. OCR识别失败

**可能原因**:
- 图片质量太低
- 图片不是账单截图
- 图片格式不支持

**解决方法**:
- 使用清晰的账单截图
- 确保图片包含完整的账单信息
- 检查图片格式是否支持

### 2. 识别结果不准确

**可能原因**:
- 图片模糊
- 账单格式特殊
- OCR模型限制

**解决方法**:
- 使用高分辨率图片
- 确保图片清晰
- 可以尝试重新解析

### 3. 导入错误

**错误**: `ModuleNotFoundError: No module named 'utils'`

**解决方法**:
```bash
# 确保在项目根目录运行
cd /workspace
python test_ocr.py test_images/bill.jpg
```

## 性能说明

- OCR识别速度取决于图片大小和复杂度
- 一般识别时间: 1-5秒
- 批量处理会依次处理，总时间 = 单张时间 × 数量

## 注意事项

1. **首次运行**: PaddleOCR首次运行会下载模型文件，需要一些时间
2. **内存占用**: OCR识别需要一定内存，建议至少2GB可用内存
3. **测试文件**: `test_upload.py` 会在 `test_uploads/` 目录创建测试文件，可以使用 `--cleanup` 清理

## 示例测试图片

建议准备以下类型的测试图片：
- 支付宝账单截图
- 微信支付账单截图
- 各种金额和类型的账单

## 扩展使用

### 集成到CI/CD

```bash
# 在CI中测试OCR功能
python test_ocr.py test_images/*.jpg
if [ $? -eq 0 ]; then
    echo "OCR测试通过"
else
    echo "OCR测试失败"
    exit 1
fi
```

### 批量处理脚本

```bash
#!/bin/bash
# 批量处理目录中的所有图片
for img in test_images/*.{jpg,png}; do
    echo "处理: $img"
    python test_ocr.py "$img"
done
```
